name: Deploy Backend

on:
  workflow_run:
    workflows: [Upstream Sync]
    types: [completed]
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Deploy Backend
        shell: bash
        run: |
          # 设置变量
          use_worker_assets="${{ secrets.USE_WORKER_ASSETS }}"
          use_worker_assets_with_telegram="${{ secrets.USE_WORKER_ASSETS_WITH_TELEGRAM }}"
          use_mail_wasm_parser="${{ secrets.BACKEND_USE_MAIL_WASM_PARSER }}"
          
          # 1. 如果开启了 Assets 编译前端
          if [ -z "$use_worker_assets" ]; then
            echo "Skipping frontend build as USE_WORKER_ASSETS is empty"
          else
            echo "Starting frontend build..."
            cd frontend/
            pnpm install --no-frozen-lockfile
            if [ -n "$use_worker_assets_with_telegram" ]; then
              echo "Building with telegram pages"
              pnpm build:telegram:pages
            else
              echo "Building with normal pages"
              pnpm build:pages
            fi
            cd ..
          fi

          # 2. 准备后端环境
          cd worker/
          if [ -n "${{ secrets.BACKEND_TOML }}" ]; then
            echo '${{ secrets.BACKEND_TOML }}' > wrangler.toml
          else
            echo "ERROR: BACKEND_TOML secret is missing!"
            exit 1
          fi
          
          pnpm install --no-frozen-lockfile

          # 3. 补丁处理
          if [ -n "$use_mail_wasm_parser" ]; then
            echo "Applying mail-parser-wasm-worker patch..."
            pnpm add mail-parser-wasm-worker
            git apply ../.github/config/mail-parser-wasm-worker.patch
          fi

          # 4. 执行部署 (直接运行，不隐藏报错信息)
          echo "Starting deployment to Cloudflare..."
          pnpm run deploy
          
          echo "Deployment successful for ${{ github.ref_name }}"
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
